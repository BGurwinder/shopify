<div class="product-section page-width">
  <div class="main-product-layout">
    <!-- Left Column: Gallery & Accordions -->
    <div class="product-left-col">
      <div class="product-gallery">
        <div class="product-main-image">
          <button class="gallery-nav prev" aria-label="Previous image">
            <svg aria-hidden="true" focusable="false" role="presentation" class="icon icon-caret" viewBox="0 0 10 6">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M9.354.646a.5.5 0 00-.708 0L5 4.293 1.354.646a.5.5 0 00-.708.708l4 4a.5.5 0 00.708 0l4-4a.5.5 0 000-.708z" fill="currentColor" transform="rotate(90 5 3)">
            </svg>
          </button>

          {% if product.featured_media %}
            {{
              product.featured_media
              | image_url: width: 1000
              | image_tag: loading: 'lazy', class: 'main-img', id: 'MainImage'
            }}
          {% else %}
            {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
          {% endif %}

          <button class="gallery-nav next" aria-label="Next image">
            <svg aria-hidden="true" focusable="false" role="presentation" class="icon icon-caret" viewBox="0 0 10 6">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M9.354.646a.5.5 0 00-.708 0L5 4.293 1.354.646a.5.5 0 00-.708.708l4 4a.5.5 0 00.708 0l4-4a.5.5 0 000-.708z" fill="currentColor" transform="rotate(-90 5 3)">
            </svg>
          </button>

          <div class="product-thumbnails">
            {% for media in product.media %}
              <div class="thumbnail {% if forloop.first %}active{% endif %}" data-media-id="{{ media.id }}">
                {{ media | image_url: width: 200 | image_tag: loading: 'lazy' }}
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Accordions removed (moved to separate section) -->
    </div>

    <!-- Right Column: Info & Badges -->
    <div class="product-info">
      <h1 class="product-title">{{ product.title }}</h1>
      <div class="product-price">
        {{ product.price | money }}
        <span class="price-tax-note">.Inclusive of all taxes</span>
      </div>

      <div class="product-description-short">
        {{ product.description | strip_html | truncatewords: 20 }}
      </div>

      {%- form 'product', product -%}
        <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

        <!-- Variants -->
        {% unless product.has_only_default_variant %}
          <div class="product-variants">
            {% for option in product.options_with_values %}
              <div class="product-option">
                <label class="option-label">{{ option.name }}</label>
                <div class="option-values">
                  {% for value in option.values %}
                    <input
                      type="radio"
                      id="Option-{{ section.id }}-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}"
                      name="options[{{ option.name | escape }}]"
                      value="{{ value | escape }}"
                      {% if option.selected_value == value %}
                        checked
                      {% endif %}
                      class="visually-hidden variant-input"
                    >
                    <label
                      for="Option-{{ section.id }}-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}"
                      class="variant-label {% if option.name == 'Color' %}variant-swatch{% endif %}"
                      {% if option.name == 'Color' %}
                        {% assign color_value = value | downcase %}

                        {% assign option_index = forloop.parentloop.index0 %}
                        {% for variant in product.variants %}
                          {% if variant.options[option_index] == value %}
                            {% if variant.metafields.custom.color_hex.value != blank %}
                              {% assign color_value = variant.metafields.custom.color_hex.value %}
                              {% break %}
                            {% endif %}
                          {% endif %}
                        {% endfor %}

                        {% comment %} Fallback for common non-standard colors if no metafield {% endcomment %}
                        {% assign value_downcase = value | downcase %}
                        {% if color_value == value_downcase %}
                          {% case color_value %}
                            {% when 'bronze' -%}
                              {%- assign color_value = '#CD7F32' %}
                            {% when 'gold' -%}
                              {%- assign color_value = '#FFD700' %}
                            {% when 'silver' -%}
                              {%- assign color_value = '#C0C0C0' %}
                            {% when 'navy' -%}
                              {%- assign color_value = '#000080' %}
                            {% when 'burgundy' -%}
                              {%- assign color_value = '#800020' %}
                            {% when 'teal' -%}
                              {%- assign color_value = '#008080' %}
                            {% when 'olive' -%}
                              {%- assign color_value = '#808000' %}
                            {% when 'maroon' -%}
                              {%- assign color_value = '#800000' %}
                            {% when 'beige' -%}
                              {%- assign color_value = '#F5F5DC' %}
                            {% when 'cream' -%}
                              {%- assign color_value = '#FFFDD0' %}
                            {% when 'mustard' -%}
                              {%- assign color_value = '#FFDB58' %}
                            {% when 'rust' -%}
                              {%- assign color_value = '#B7410E' %}
                          {% endcase %}
                        {% endif %}

                        style="background-color: {{ color_value }};"
                        title="{{ value }}"
                      {% endif %}
                    >
                      {% unless option.name == 'Color' %}{{ value }}{% endunless %}
                    </label>
                  {% endfor %}
                  {% if option.name == 'Size' %}
                    <a href="#" class="size-chart-link">
                      Size chart
                      {% render 'size-cart' %}
                    </a>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% endunless %}

        <!-- Quantity & Add to Cart -->
        <input type="hidden" name="return_to" value="/checkout" disabled id="BuyNowRedirect">
        <div class="product-actions">
          <div class="quantity-selector">
            <label class="visually-hidden" for="Quantity">Quantity</label>
            <div class="qty-wrapper">
              <div class="qty-label">Quantity</div>
              <div class="qty-controls">
                <button type="button" class="qty-btn minus">-</button>
                <input type="number" name="quantity" value="1" min="1" class="qty-input" id="Quantity">
                <button type="button" class="qty-btn plus">+</button>
              </div>
            </div>
          </div>
          <div class="action-buttons">
            <button type="submit" name="add" class="button button--secondary add-to-cart-btn">Add To Cart</button>
            <button
              type="button"
              class="button button--primary buy-now-btn"
              onclick="buyNow()"
            >
              {{ 'products.product.buy_now' | t | default: 'Buy Now' }}
            </button>
          </div>
        </div>
      {%- endform -%}

      <script>
        var productVariants = {{ product.variants | json }};

        function getSelectedOptions() {
          var form = document.querySelector('form[action*="/cart/add"]');
          if (!form) return [];
          // Get all checked radio buttons inside the form
          var checkedRadios = Array.from(form.querySelectorAll('input[type="radio"]:checked'));
          // Map to their values
          return checkedRadios.map(function(input) { return input.value; });
        }

        function updateVariantId() {
          var options = getSelectedOptions();
          // Find variant that matches all selected options
          var matchedVariant = productVariants.find(function(variant) {
            // variant.options is an array of values like ["Red", "Small"]
            // We check if every selected option matches the variant's option at that index
            // Note: This assumes options are in the same order.
            // Better approach: check if variant.options includes the value? No, order matters for index.
            // Shopify outputs options in order.

            if (options.length !== variant.options.length) return false;

            for (var i = 0; i < options.length; i++) {
              if (variant.options[i] !== options[i]) return false;
            }
            return true;
          });

          if (matchedVariant) {
            var idInput = document.querySelector('input[name="id"]');
            if (idInput) idInput.value = matchedVariant.id;
          }
        }

        // Add event listeners to variant inputs
        document.addEventListener('DOMContentLoaded', function() {
          var variantInputs = document.querySelectorAll('input[name^="options"]');
          variantInputs.forEach(function(input) {
            input.addEventListener('change', updateVariantId);
          });
        });

        function buyNow() {
          var form = document.querySelector('form[action*="/cart/add"]');
          if (!form) return;

          var variantId = form.querySelector('input[name="id"]').value;
          var qtyInput = form.querySelector('input[name="quantity"]');
          var qty = qtyInput ? qtyInput.value : 1;

          // Direct checkout permalink: /cart/{variant_id}:{quantity}
          window.location.href = '/cart/' + variantId + ':' + qty;
        }
      </script>

      <!-- Trust Badges removed (moved to separate section) -->
    </div>
  </div>
</div>

{% render 'size-chart-modal',
  bg_color: section.settings.size_chart_bg_color,
  text_color: section.settings.size_chart_text_color,
  font_size: section.settings.size_chart_font_size,
  font_weight: section.settings.size_chart_font_weight
%}

{% schema %}
{
  "name": "Product Information",
  "settings": [
    {
      "type": "header",
      "content": "Size Chart Settings"
    },
    {
      "type": "color",
      "id": "size_chart_bg_color",
      "label": "Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "size_chart_text_color",
      "label": "Text Color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "size_chart_font_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Font Size",
      "default": 16
    },
    {
      "type": "select",
      "id": "size_chart_font_weight",
      "label": "Font Weight",
      "options": [
        {
          "value": "normal",
          "label": "Normal"
        },
        {
          "value": "bold",
          "label": "Bold"
        }
      ],
      "default": "normal"
    }
  ]
}
{% endschema %}
